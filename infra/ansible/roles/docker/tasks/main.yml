---
- name: Install required packages (curl)
  become: true
  yum:
    name:
      - curl
    state: present

- name: Install Docker on Amazon Linux
  become: true
  yum:
    name: docker
    state: present

- name: Enable and start Docker
  become: true
  service:
    name: docker
    enabled: yes
    state: started

- name: Add ec2-user to docker group
  become: true
  user:
    name: ec2-user
    groups: docker
    append: yes

- name: Install docker compose v2 plugin
  become: true
  shell: |
    set -e
    mkdir -p /usr/local/lib/docker/cli-plugins

    # Download only if missing
    if [ ! -x /usr/local/lib/docker/cli-plugins/docker-compose ]; then
      curl -fsSL -o /usr/local/lib/docker/cli-plugins/docker-compose \
        https://github.com/docker/compose/releases/latest/download/docker-compose-linux-x86_64
      chmod +x /usr/local/lib/docker/cli-plugins/docker-compose
    fi

    # Optional: allow `docker-compose` command too
    ln -sf /usr/local/lib/docker/cli-plugins/docker-compose /usr/local/bin/docker-compose
  args:
    executable: /bin/bash

- name: Verify docker compose works
  become: true
  command: docker compose version
